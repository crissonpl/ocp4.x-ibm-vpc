########################################################
# Playbooks: Modify netplan file
########################################################
---
- name: Fetch IP address
  shell: ip addr show eth0 | awk '/inet/ {print $2}' | cut -d/ -f1 | head -1
  register: IP

- name: Fetch mac address
  shell: ip addr show eth0 | awk '/ether/ {print $2}' | cut -d/ -f1
  register: MAC

- name: Fetch DNS server address
  shell: cat "{{ dns_server }}" | grep -v '^#' | grep nameserver | awk '{print $2}'
  register: DNS

- name: Set variables
  set_fact:
      HOST_IP_ADDRESS: "{{ IP.stdout }}"
      HOST_MAC_ADDRESS: "{{ MAC.stdout }}"
      HOST_DNS_ADDRESS: "{{ DNS.stdout }}"
  
- name: "Replace IPaddress in network init file"
  replace: 
      path: "{{ netplan_dir }}/{{ netplan }}"
      regexp: "{{ item.regexp }}"
      replace: "{{ item.replace }}"
  with_items:
      - { regexp: 'REPLACE_IPADDRESS', replace: "{{ HOST_IP_ADDRESS }}" }
      - { regexp: 'REPLACE_MACADDRESS', replace: "{{ HOST_MAC_ADDRESS }}" }
      - { regexp: 'REPLACE_DNSADDRESS', replace: "{{ HOST_DNS_ADDRESS }}" }
  become: yes

